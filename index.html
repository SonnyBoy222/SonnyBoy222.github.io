<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>母亲节祝福墙</title>
    <style>
        /* 保持原有样式不变 */
        body {
            background: linear-gradient(135deg, #ffe6f2 30%, #f0f8ff);
            font-family: "Microsoft YaHei", sans-serif;
            padding: 20px;
        }

        #blessing-wall {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255,255,255,0.92);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
        }

        .message-card {
            background: #fff0f5;
            padding: 15px;
            margin: 10px 0;
            border-left: 5px solid #ff69b4;
            animation: fadeIn 0.8s ease-out forwards;
            box-shadow: 0 3px 8px rgba(255,105,180,0.15);
        }

        #countdown {
            padding: 15px 20px;
            margin: 20px 0;
            background: rgba(255,105,180,0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            color: #d6336c;
            animation: 
                pulse 2s ease-in-out infinite,
                fadeIn 0.8s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
</head>
<body>
    <div id="blessing-wall">
        <div id="countdown"></div>
        <div id="message-container"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="写下您的祝福..." style="width: 70%; padding: 8px;">
            <button type="submit" style="padding: 8px 20px; background: #ff69b4; color: white; border: none; border-radius: 4px;">提交祝福</button>
        </form>
    </div>

    <script>
        // GitHub配置（需用户修改部分）↓↓↓
        const GITHUB_CONFIG = {
            owner: SonnyBoy222,    // 替换为你的GitHub用户名
            repo: SonnyBoy222.github.io,           // 仓库名称
            branch: Mo3,                   // 分支名称
            dataPath: data/messages.json,   // 数据文件路径
            token: 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        // 生成的GitHub Token
        };
        // GitHub配置（需用户修改部分）↑↑↑

        // GitHub API端点
        const API_URL = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataPath}`;

        // 初始化存储系统
        const initStorage = async () => {
            try {
                const response = await fetch(API_URL, {
                    headers: { Authorization: `token ${GITHUB_CONFIG.token}` }
                });
                
                if (response.status === 404) {
                    // 首次初始化数据
                    const initialMessages = [
                        {
                            text: "妈妈节日快乐",
                            timestamp: "2025/05/11 17:05:20",
                            id: Date.now()
                        },
                        {
                            text: "🙂",
                            timestamp: "2025/05/11 17:05:21",
                            id: Date.now() + 1
                        }
                    ];
                    await updateGitHubFile(JSON.stringify(initialMessages), '初始化数据');
                }
            } catch (error) {
                console.error('存储初始化失败:', error);
            }
        };

        // 更新GitHub文件
        const updateGitHubFile = async (content, commitMessage) => {
            try {
                // 获取当前文件SHA
                const existingFile = await fetch(API_URL, {
                    headers: { Authorization: `token ${GITHUB_CONFIG.token}` }
                }).then(res => res.ok ? res.json() : null);

                // 构建请求体
                const payload = {
                    message: commitMessage,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: GITHUB_CONFIG.branch
                };

                if (existingFile && existingFile.sha) {
                    payload.sha = existingFile.sha;
                }

                // 提交更新
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 
                        Authorization: `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`GitHub API错误: ${response.status}`);
                }
                return true;
            } catch (error) {
                console.error('文件更新失败:', error);
                throw error;
            }
        };

        // 加载消息
        const loadMessages = async () => {
            try {
                const response = await fetch(
                    `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.dataPath}`
                );
                return await response.json();
            } catch (error) {
                console.error('消息加载失败:', error);
                return [];
            }
        };

        // 渲染消息
        const renderMessages = async () => {
            const container = document.getElementById('message-container');
            try {
                const messages = await loadMessages();
                container.innerHTML = messages.map(msg => `
                    <div class="message-card">
                        <p>${msg.text}</p>
                        <span class="timestamp">${msg.timestamp}</span>
                    </div>
                `).reverse().join(''); // 保持倒序显示
            } catch (error) {
                container.innerHTML = '<p>消息加载失败，请刷新重试</p>';
            }
        };

        // 表单提交处理
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (text) {
                try {
                    const messages = await loadMessages();
                    const newMessage = {
                        text,
                        timestamp: new Date().toLocaleString(),
                        id: Date.now()
                    };
                    
                    // 存储优化（保留最新100条）
                    const updatedMessages = [...messages, newMessage].slice(-100);
                    
                    await updateGitHubFile(
                        JSON.stringify(updatedMessages),
                        `添加新消息: ${text.substring(0, 20)}${text.length > 20 ? '...' : ''}`
                    );
                    
                    await renderMessages();
                    input.value = '';
                } catch (error) {
                    alert('提交失败: ' + error.message);
                }
            }
        });

        // 倒计时系统（保持不变）
        let lastDays = Infinity;
        function updateMotherDayCountdown() {
            const nextYear = new Date().getFullYear() + 1;
            const targetDate = new Date(`${nextYear}-05-11`);
            const now = new Date();
            const diff = targetDate - now;
            const days = Math.ceil(diff / 86400000);

            if(days !== lastDays) {
                const countdownEl = document.getElementById('countdown');
                countdownEl.style.animation = 'none';
                void countdownEl.offsetWidth;
                countdownEl.style.animation = 'numberUpdate 0.6s ease-out';
            }

            document.getElementById('countdown').innerHTML = 
                `距离${nextYear}年母亲节还有 <strong>${days}</strong> 天`;
            lastDays = days;
        }

        // 初始化执行
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await initStorage();
                await renderMessages();
                updateMotherDayCountdown();
                setInterval(updateMotherDayCountdown, 1000);
            } catch (error) {
                console.error('初始化失败:', error);
            }
        });
    </script>
</body>
</html>

