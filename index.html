<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯äº²èŠ‚ç¥ç¦å¢™</title>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        body {
            background: linear-gradient(135deg, #ffe6f2 30%, #f0f8ff);
            font-family: "Microsoft YaHei", sans-serif;
            padding: 20px;
        }

        #blessing-wall {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255,255,255,0.92);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
        }

        .message-card {
            background: #fff0f5;
            padding: 15px;
            margin: 10px 0;
            border-left: 5px solid #ff69b4;
            animation: fadeIn 0.8s ease-out forwards;
            box-shadow: 0 3px 8px rgba(255,105,180,0.15);
        }

        #countdown {
            padding: 15px 20px;
            margin: 20px 0;
            background: rgba(255,105,180,0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            color: #d6336c;
            animation: 
                pulse 2s ease-in-out infinite,
                fadeIn 0.8s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
</head>
<body>
    <div id="blessing-wall">
        <div id="countdown"></div>
        <div id="message-container"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="å†™ä¸‹æ‚¨çš„ç¥ç¦..." style="width: 70%; padding: 8px;">
            <button type="submit" style="padding: 8px 20px; background: #ff69b4; color: white; border: none; border-radius: 4px;">æäº¤ç¥ç¦</button>
        </form>
    </div>

    <script>
        // GitHubé…ç½®ï¼ˆéœ€ç”¨æˆ·ä¿®æ”¹éƒ¨åˆ†ï¼‰â†“â†“â†“
        const GITHUB_CONFIG = {
            owner: SonnyBoy222,    // æ›¿æ¢ä¸ºä½ çš„GitHubç”¨æˆ·å
            repo: SonnyBoy222.github.io,           // ä»“åº“åç§°
            branch: Mo3,                   // åˆ†æ”¯åç§°
            dataPath: data/messages.json,   // æ•°æ®æ–‡ä»¶è·¯å¾„
            token: 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        // ç”Ÿæˆçš„GitHub Token
        };
        // GitHubé…ç½®ï¼ˆéœ€ç”¨æˆ·ä¿®æ”¹éƒ¨åˆ†ï¼‰â†‘â†‘â†‘

        // GitHub APIç«¯ç‚¹
        const API_URL = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataPath}`;

        // åˆå§‹åŒ–å­˜å‚¨ç³»ç»Ÿ
        const initStorage = async () => {
            try {
                const response = await fetch(API_URL, {
                    headers: { Authorization: `token ${GITHUB_CONFIG.token}` }
                });
                
                if (response.status === 404) {
                    // é¦–æ¬¡åˆå§‹åŒ–æ•°æ®
                    const initialMessages = [
                        {
                            text: "å¦ˆå¦ˆèŠ‚æ—¥å¿«ä¹",
                            timestamp: "2025/05/11 17:05:20",
                            id: Date.now()
                        },
                        {
                            text: "ğŸ™‚",
                            timestamp: "2025/05/11 17:05:21",
                            id: Date.now() + 1
                        }
                    ];
                    await updateGitHubFile(JSON.stringify(initialMessages), 'åˆå§‹åŒ–æ•°æ®');
                }
            } catch (error) {
                console.error('å­˜å‚¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        };

        // æ›´æ–°GitHubæ–‡ä»¶
        const updateGitHubFile = async (content, commitMessage) => {
            try {
                // è·å–å½“å‰æ–‡ä»¶SHA
                const existingFile = await fetch(API_URL, {
                    headers: { Authorization: `token ${GITHUB_CONFIG.token}` }
                }).then(res => res.ok ? res.json() : null);

                // æ„å»ºè¯·æ±‚ä½“
                const payload = {
                    message: commitMessage,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: GITHUB_CONFIG.branch
                };

                if (existingFile && existingFile.sha) {
                    payload.sha = existingFile.sha;
                }

                // æäº¤æ›´æ–°
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 
                        Authorization: `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`GitHub APIé”™è¯¯: ${response.status}`);
                }
                return true;
            } catch (error) {
                console.error('æ–‡ä»¶æ›´æ–°å¤±è´¥:', error);
                throw error;
            }
        };

        // åŠ è½½æ¶ˆæ¯
        const loadMessages = async () => {
            try {
                const response = await fetch(
                    `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.dataPath}`
                );
                return await response.json();
            } catch (error) {
                console.error('æ¶ˆæ¯åŠ è½½å¤±è´¥:', error);
                return [];
            }
        };

        // æ¸²æŸ“æ¶ˆæ¯
        const renderMessages = async () => {
            const container = document.getElementById('message-container');
            try {
                const messages = await loadMessages();
                container.innerHTML = messages.map(msg => `
                    <div class="message-card">
                        <p>${msg.text}</p>
                        <span class="timestamp">${msg.timestamp}</span>
                    </div>
                `).reverse().join(''); // ä¿æŒå€’åºæ˜¾ç¤º
            } catch (error) {
                container.innerHTML = '<p>æ¶ˆæ¯åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
            }
        };

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (text) {
                try {
                    const messages = await loadMessages();
                    const newMessage = {
                        text,
                        timestamp: new Date().toLocaleString(),
                        id: Date.now()
                    };
                    
                    // å­˜å‚¨ä¼˜åŒ–ï¼ˆä¿ç•™æœ€æ–°100æ¡ï¼‰
                    const updatedMessages = [...messages, newMessage].slice(-100);
                    
                    await updateGitHubFile(
                        JSON.stringify(updatedMessages),
                        `æ·»åŠ æ–°æ¶ˆæ¯: ${text.substring(0, 20)}${text.length > 20 ? '...' : ''}`
                    );
                    
                    await renderMessages();
                    input.value = '';
                } catch (error) {
                    alert('æäº¤å¤±è´¥: ' + error.message);
                }
            }
        });

        // å€’è®¡æ—¶ç³»ç»Ÿï¼ˆä¿æŒä¸å˜ï¼‰
        let lastDays = Infinity;
        function updateMotherDayCountdown() {
            const nextYear = new Date().getFullYear() + 1;
            const targetDate = new Date(`${nextYear}-05-11`);
            const now = new Date();
            const diff = targetDate - now;
            const days = Math.ceil(diff / 86400000);

            if(days !== lastDays) {
                const countdownEl = document.getElementById('countdown');
                countdownEl.style.animation = 'none';
                void countdownEl.offsetWidth;
                countdownEl.style.animation = 'numberUpdate 0.6s ease-out';
            }

            document.getElementById('countdown').innerHTML = 
                `è·ç¦»${nextYear}å¹´æ¯äº²èŠ‚è¿˜æœ‰ <strong>${days}</strong> å¤©`;
            lastDays = days;
        }

        // åˆå§‹åŒ–æ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await initStorage();
                await renderMessages();
                updateMotherDayCountdown();
                setInterval(updateMotherDayCountdown, 1000);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
    </script>
</body>
</html>

